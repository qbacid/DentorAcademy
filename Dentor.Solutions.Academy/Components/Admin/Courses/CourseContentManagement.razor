@page "/admin/course/{CourseId:int}/content"

@using System.Linq
@using Dentor.Academy.WebApp.DTOs.Quiz
@using Dentor.Solutions.Academy.DTOs.Course
@using Dentor.Solutions.Academy.Extensions
@using Dentor.Solutions.Academy.Interfaces
@using Dentor.Solutions.Academy.Models

@inject ICourseContentService ContentService
@inject ICourseManagementService CourseService
@inject IQuizTakingService QuizTakingService
@inject IDialogService DialogServiceProvider

@inject IToastService ToastService

@rendermode InteractiveServer

<PageTitle>Course Content - @(_courseName ?? "Loading...")</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Style="padding: 1rem; width: 100%;">

    <!-- Breadcrumbs -->
    <FluentStack Orientation="Orientation.Horizontal"
                 HorizontalAlignment="HorizontalAlignment.Start"
                 VerticalAlignment="VerticalAlignment.Center"
                 Width="100%">
        <Breadcrumb Items="@_breadcrumbItems"/>
    </FluentStack>

    <!-- Header Section -->
    <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center"
                 Width="100%">
        <FluentStack Orientation="Orientation.Vertical" Style="flex: 1;">
            <FluentLabel Typo="Typography.H3">
                <FluentIcon Value="@(new Icons.Regular.Size24.BookOpen())"/>
                @($"{_courseName}: Modules" ?? "Loading...")
            </FluentLabel>
            <FluentLabel Typo="Typography.Body">Build your course by adding modules (sections) and content items
                (lectures, videos, quizzes)
            </FluentLabel>
        </FluentStack>
    </FluentStack>

    @if (_isLoading)
    {
        <LoadingSpinner Message="Loading course content..."/>
    }
    else if (_modules.Any())
    {
        <FluentStack Orientation="Orientation.Vertical">
            <FluentStack Orientation="Orientation.Horizontal" Width="100%" VerticalAlignment="VerticalAlignment.Center">
                <FluentSpacer/>
                <FluentButton Appearance="Appearance.Neutral" slot="end"
                              OnClick="@(async () => { await ShowAddModuleModal(); })"
                              IconStart="@(new Icons.Regular.Size20.AddCircle())">
                    Create Module
                </FluentButton>
                
            </FluentStack>
        </FluentStack>

        <FluentDivider Style="width: 100%"/>

        <!-- Modules List -->
        <FluentAccordion Style="width: 100%; margin-bottom: 1rem;" 
                         @ref="_accordionModules" ExpandMode="AccordionExpandMode.Multi">
            @foreach (var module in _modules.OrderBy(m => m.OrderIndex))
            {
                <FluentAccordionItem Id="@(module.Id.ToString())"
                                     @bind-Expanded="@(_expandedModules[module.Id])"
                                     Data="@module">
                    <HeadingTemplate>
                        <FluentStack Orientation="Orientation.Horizontal" Width="100%"
                                     VerticalAlignment="VerticalAlignment.Center">
                            <FluentLabel Style="min-width: 250px" Typo="Typography.Subject" Weight="FontWeight.Bold">
                                @module.Title
                            </FluentLabel>
                            <FluentSpacer/>
                            
                            <FluentButton IconStart="@(new Icons.Regular.Size20.AddCircle())"

                                          Appearance="Appearance.Outline"
                                          OnClick="@(async () => await HandleAddNewContent(_modules.First()))"
                                          Title="Add Content">
                                Add Content
                            </FluentButton>
                            
                            <FluentButton IconStart="@(new Icons.Regular.Size20.ArrowDown())"
                                          Appearance="Appearance.Outline" 
                                          OnClick="@(async () => await HandleMoveDown(module))"/>

                            <FluentButton IconStart="@(new Icons.Regular.Size20.ArrowUp())"
                                          Appearance="Appearance.Outline"
                                          OnClick="@(async () => await HandleMoveUp(module))"/>

                            <FluentButton IconStart="@(new Icons.Regular.Size20.Edit())"
                                          OnClick="@(async () => await UpdateModule(module))"
                                          Appearance="Appearance.Outline"/>

                            <FluentButton IconStart="@(new Icons.Regular.Size20.Delete())"
                                          OnClick="@(async () => await DeleteModule(module))"
                                          Appearance="Appearance.Outline"/>
                        </FluentStack>
                    </HeadingTemplate>

                    <ChildContent>
                        <FluentStack Orientation="Orientation.Vertical" Width="100%" VerticalGap="16">
                            @if (module.Contents.Any())
                            {
                                <FluentStack Orientation="Orientation.Horizontal">
                                    <FluentLabel>@($"{module.Contents.Count} Contents") </FluentLabel>
                                    <FluentSpacer/>
                                    <FluentButton IconStart="@(new Icons.Regular.Size20.AddCircle())"

                                                  Appearance="Appearance.Outline"
                                                  OnClick="@(async () => await HandleAddNewContent(module))"
                                                  Title="Add Content">
                                        Add Content
                                    </FluentButton>
                                </FluentStack>
                                <FluentDivider />
                                <FluentDataGrid MultiLine="true"
                                                Items="@(module.Contents.AsQueryable())"
                                                TGridItem="CourseContentDto"
                                                Style="width: 100%;"
                                                RowSize="DataGridRowSize.Medium">

                                    <PropertyColumn Property="arg => arg.Title"
                                                    HeaderTooltip="Content Title, indicate how the content will be presented to students"
                                                    Title="Title"/>

                                    <PropertyColumn Property="arg => arg.Description"
                                                    HeaderTooltip="Content Description"
                                                    Title="Description"/>

                                    <TemplateColumn Title="Is Published"
                                                    HeaderTooltip="Switch to publish or unpublish this module's content">
                                        <FluentSwitch @bind-Value=@context.IsPublished CheckedMessage="Published"
                                                      UncheckedMessage="Draft"/>
                                    </TemplateColumn>

                                    <TemplateColumn Title="Actions" Align="@Align.End">
                                        <FluentStack Orientation="Orientation.Horizontal"
                                                     VerticalAlignment="VerticalAlignment.Center">
                                            <FluentButton aria-label="Edit"
                                                          IconStart="@(new Icons.Regular.Size16.Edit())"
                                                          Title="Edit"/>

                                            <FluentButton aria-label="Delete"
                                                          IconStart="@(new Icons.Regular.Size16.Delete())"
                                                          Title="Delete"/>

                                        </FluentStack>
                                    </TemplateColumn>
                                </FluentDataGrid>
                            }
                            else
                            {
                                <FluentStack Orientation="Orientation.Vertical"
                                             HorizontalAlignment="HorizontalAlignment.Center"
                                             Style="padding: 4rem 2rem;">
                                    <FluentIcon Value="@(new Icons.Regular.Size32.BookOpenLightbulb())"
                                                Color="Color.Neutral"/>
                                    <FluentLabel Typo="Typography.H4" Style="margin-top: 1rem;">No Lessons yet
                                    </FluentLabel>
                                    <FluentLabel Typo="Typography.Body" Color="Color.Neutral">Start building your course
                                        by adding your first
                                        content to this module.
                                    </FluentLabel>
                                    
                                    <FluentButton IconStart="@(new Icons.Regular.Size20.AddCircle())"
                                                  Appearance="Appearance.Outline"
                                                  OnClick="@(async () => { await HandleAddNewContent(module); })"
                                                  Title="Add Content">
                                        Add Content
                                    </FluentButton>
                                </FluentStack>
                            }
                        </FluentStack>
                    </ChildContent>
                </FluentAccordionItem>
            }
        </FluentAccordion>
    }
    else
    {
        <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center"
                     Style="padding: 4rem 2rem;">
            <FluentIcon Value="@(new Icons.Regular.Size48.BookOpen())" Color="Color.Neutral"/>
            <FluentLabel Typo="Typography.H4" Style="margin-top: 1rem;">No modules yet</FluentLabel>
            <FluentLabel Typo="Typography.Body" Color="Color.Neutral">Start building your course by adding your first
                module
            </FluentLabel>
            <FluentButton Appearance="Appearance.Accent"
                          OnClick="ShowAddModuleModal"
                          IconStart="@(new Icons.Regular.Size20.AddCircle())"
                          Style="margin-top: 1rem;">
                Add First Module
            </FluentButton>
        </FluentStack>
    }
</FluentStack>

@code {
    [Parameter] public int CourseId { get; set; }

    private string? _courseName;
    private bool _isLoading = true;
    private bool _isSaving;
    private List<CourseModuleDto> _modules = new();
    
    private Dictionary<int, bool> _expandedModules = new();
    
    private List<QuizCardDto> _availableQuizzes = new();
    private List<BreadcrumbItem> _breadcrumbItems = new();
    private IBrowserFile? _selectedFile;
    private QuizCardDto? _selectedQuiz;

    // Module modal
    private CourseModuleDto? _editingModule;
    private CourseModuleDto _dialogModuleData = new();

    // Content modal
    private bool _showContentModal;
    private CourseContentDto? _editingContent;
    private ContentFormModel _contentForm = new();
    private int _uploadProgress;

    // Menu button
    private FluentMenuButton _menuButton = new();
    private Dictionary<string, string> _itemsTypeOfContent = new();
    private FluentAccordion _accordionModules = new();
    private bool _accordionIsOpen = true;

    protected override async Task OnInitializedAsync()
    {
        var contentTypes = Enum.GetValues<CourseContentType>();
        _itemsTypeOfContent.Clear();
        foreach (var contentType in contentTypes)
        {
            _itemsTypeOfContent.Add(contentType.ToString(), contentType.GetDisplayName());
        }

        await LoadCourseData();
    }

    private async Task LoadCourseData()
    {
        _isLoading = true;
        try
        {
            var course = await CourseService.GetCourseByIdAsync(CourseId);
            if (course != null)
            {
                _courseName = course.Title;
            }

            // Initialize breadcrumb items
            _breadcrumbItems = new List<BreadcrumbItem>
            {
                new BreadcrumbItem("Courses", "/admin/courses"),
                new BreadcrumbItem(_courseName ?? "Current", $"/admin/course/{CourseId}"),
                new BreadcrumbItem("Course Content")
            };

            _modules = await ContentService.GetCourseModulesAsync(CourseId);

            // Load available quizzes
            _availableQuizzes = await QuizTakingService.GetAvailableQuizzesAsync();

            // Auto-expand all modules initially
            _modules.ForEach(m => _expandedModules[m.Id] = true);
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading course: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }
    

    #region Module Management

    private async Task ShowAddModuleModal()
    {
        _editingModule = null;
        _dialogModuleData = new()
        {
            OrderIndex = _modules.Count,
            CourseId = CourseId
        };

        var dialog = await DialogServiceProvider.ShowDialogAsync<CourseAddModuleDialog>(_dialogModuleData, new DialogParameters
        {
            Title = "Manage Course Modules",
            PrimaryAction = "Add Module",
            SecondaryAction = "Cancel",
            Width = "620px",
            Height = "auto",
            Modal = true,
            PreventDismissOnOverlayClick = true
        });

        var result = await dialog.Result;
        if (!result.Cancelled && result.Data is CourseModuleDto data)
        {
            _modules.Add(data);
            await SaveModule();
        }
    }

    private void ShowEditModuleModal(CourseModuleDto module)
    {
        _editingModule = module;
        //TODO: Add module details to dialog
    }

    private async Task SaveModule()
    {
        if (string.IsNullOrWhiteSpace(_dialogModuleData.Title))
        {
            ToastService.ShowWarning("Module title is required");
            return;
        }

        _isSaving = true;
        try
        {
            if (_editingModule == null)
            {
                // Create new module
                var createDto = new CreateCourseModuleDto
                {
                    CourseId = CourseId,
                    Title = _dialogModuleData.Title,
                    Description = _dialogModuleData.Description,
                    OrderIndex = _dialogModuleData.OrderIndex,
                    EstimatedDurationMinutes = _dialogModuleData.EstimatedDurationMinutes
                };
                await ContentService.CreateModuleAsync(createDto);
                ToastService.ShowSuccess("Module created successfully");
            }
            else
            {
                // Update existing module
                var updateDto = new UpdateCourseModuleDto
                {
                    Title = _dialogModuleData.Title,
                    Description = _dialogModuleData.Description,
                    OrderIndex = _dialogModuleData.OrderIndex,
                    EstimatedDurationMinutes = _dialogModuleData.EstimatedDurationMinutes,
                    IsPublished = _dialogModuleData.IsPublished
                };
                await ContentService.UpdateModuleAsync(_editingModule.Id, updateDto);
                ToastService.ShowSuccess("Module updated successfully");
            }

            await LoadCourseData();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving module: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task UpdateModule(CourseModuleDto module)
    {
        _editingModule = null;
        _dialogModuleData = new()
        {
            OrderIndex = _modules.Count,
            CourseId = CourseId
        };

        var dialog = await DialogServiceProvider.ShowDialogAsync<CourseAddModuleDialog>(_dialogModuleData, new DialogParameters
        {
            Title = "Manage Course Modules",
            PrimaryAction = "Update Module",
            SecondaryAction = "Cancel",
            Width = "620px",
            Height = "auto",
            Modal = true,
            PreventDismissOnOverlayClick = true
        });

        var result = await dialog.Result;
        if (!result.Cancelled && result.Data is CourseModuleDto data)
        {
            var foundModule = _modules.First(x => x.Id == data.Id);
            foundModule.Description = data.Description;
            foundModule.IsPublished = data.IsPublished;
            foundModule.Title = data.Title;
            foundModule.EstimatedDurationMinutes = data.EstimatedDurationMinutes;

            await SaveModule();
        }
    }

    private async Task DeleteModule(CourseModuleDto module)
    {
        _expandedModules[module.Id] = true;
        var dialog = await DialogServiceProvider.ShowConfirmationAsync(
            $"Are you sure you want to delete this module {module.Title} and all its content?",
            "Delete Module",
            "Cancel",
            "Cancel");

        var result = await dialog.Result;
        if (result.Cancelled)
            return;

        try
        {
            await ContentService.DeleteModuleAsync(module.Id);
            ToastService.ShowSuccess("Module deleted successfully");
            await LoadCourseData();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error deleting module: {ex.Message}");
        }
    }

    #endregion

    #region Content_Management

    private void ShowAddContentModal(int moduleId)
    {
        _editingContent = null;
        _contentForm = new ContentFormModel
        {
            CourseModuleId = moduleId,
            OrderIndex = _modules.First(m => m.Id == moduleId).Contents.Count
        };
        _showContentModal = false;
        StateHasChanged();
        _showContentModal = true;
    }

    private void ShowEditContentModal(CourseContentDto content)
    {
        _editingContent = content;
        _contentForm = new ContentFormModel
        {
            CourseModuleId = content.CourseModuleId,
            Title = content.Title,
            Description = content.Description,
            ContentMimeType = content.ContentMimeType,
            OrderIndex = content.OrderIndex,
            DurationMinutes = content.DurationMinutes,
            ExternalUrl = content.ExternalUrl,
            QuizId = content.QuizId,
            IsFreePreview = content.IsFreePreview,
            IsDownloadable = content.IsDownloadable,
            IsMandatory = content.IsMandatory,
            IsPublished = content.IsPublished
        };

        // Set selected quiz if QuizId is present
        if (content.QuizId.HasValue)
        {
            _selectedQuiz = _availableQuizzes.FirstOrDefault(q => q.Id == content.QuizId.Value);
        }
        else
        {
            _selectedQuiz = null;
        }

        _showContentModal = false;
        StateHasChanged();
        _showContentModal = true;
    }

    private void CloseContentModal()
    {
        _showContentModal = true;
        StateHasChanged();
        _showContentModal = false;
        _editingContent = null;
        _contentForm = new();
        _uploadProgress = 0;
    }

    private async Task SaveContent()
    {
        if (string.IsNullOrWhiteSpace(_contentForm.Title))
        {
            ToastService.ShowWarning("Title and content type are required");
            return;
        }

        _isSaving = true;
        try
        {
            // Get QuizId from selected quiz if applicable
            var quizId = _selectedQuiz?.Id;

            if (_editingContent == null)
            {
                // Create new content
                var createDto = new CreateCourseContentDto
                {
                    CourseModuleId = _contentForm.CourseModuleId,
                    Title = _contentForm.Title,
                    Description = _contentForm.Description,
                    ContentMimeType = _contentForm.ContentMimeType,
                    OrderIndex = _contentForm.OrderIndex,
                    DurationMinutes = _contentForm.DurationMinutes,
                    ExternalUrl = _contentForm.ExternalUrl,
                    QuizId = quizId,
                    IsFreePreview = _contentForm.IsFreePreview,
                    IsDownloadable = _contentForm.IsDownloadable,
                    IsMandatory = _contentForm.IsMandatory
                };
                await ContentService.CreateContentAsync(createDto);
                ToastService.ShowSuccess("Content created successfully");
            }
            else
            {
                // Update existing content
                var updateDto = new UpdateCourseContentDto
                {
                    Title = _contentForm.Title,
                    Description = _contentForm.Description,
                    OrderIndex = _contentForm.OrderIndex,
                    DurationMinutes = _contentForm.DurationMinutes,
                    ExternalUrl = _contentForm.ExternalUrl,
                    QuizId = quizId,
                    IsFreePreview = _contentForm.IsFreePreview,
                    IsDownloadable = _contentForm.IsDownloadable,
                    IsMandatory = _contentForm.IsMandatory,
                    IsPublished = _contentForm.IsPublished
                };
                await ContentService.UpdateContentAsync(_editingContent.Id, updateDto);
                ToastService.ShowSuccess("Content updated successfully");
            }

            await LoadCourseData();
            CloseContentModal();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving content: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task DeleteContent(int contentId)
    {
        var dialog = await DialogServiceProvider.ShowConfirmationAsync(
            "Are you sure you want to delete this content?",
            "Delete Content",
            "Delete",
            "Cancel");

        var result = await dialog.Result;
        if (result.Cancelled)
            return;

        try
        {
            await ContentService.DeleteContentAsync(contentId);
            ToastService.ShowSuccess("Content deleted successfully");
            await LoadCourseData();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error deleting content: {ex.Message}");
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        if (e.File == null)
            return;

        _selectedFile = e.File;
        _uploadProgress = 0;

        try
        {
            // TODO: Implement actual file upload with progress tracking
            // Simulate upload progress for now
            for (int i = 0; i <= 100; i += 10)
            {
                _uploadProgress = i;
                await Task.Delay(200);
                StateHasChanged();
            }

            ToastService.ShowInfo($"File '{e.File.Name}' ready for upload. Actual upload functionality coming soon.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error handling file: {ex.Message}");
        }
    }

    #endregion

    #region Helpers

    private Icon GetContentIcon(string contentType)
    {
        return contentType switch
        {
            "Video" => new Icons.Regular.Size20.Video(),
            "Document" => new Icons.Regular.Size20.Document(),
            "PDF" => new Icons.Regular.Size20.DocumentPdf(),
            "Audio" => new Icons.Regular.Size20.MusicNote2(),
            "Quiz" => new Icons.Regular.Size20.QuestionCircle(),
            "ExternalLink" => new Icons.Regular.Size20.Link(),
            _ => new Icons.Regular.Size20.Document()
        };
    }

    private Icon GetExpandIcon(int moduleId)
    {
        return _expandedModules[moduleId]
            ? new Icons.Regular.Size20.ChevronUp()
            : new Icons.Regular.Size20.ChevronDown();
    }

    private string FormatDuration(int minutes)
    {
        if (minutes < 60)
            return $"{minutes}m";

        var hours = minutes / 60;
        var mins = minutes % 60;
        return mins > 0 ? $"{hours}h {mins}m" : $"{hours}h";
    }

    #endregion

    #region Form Models

    private class ContentFormModel
    {
        public int CourseModuleId { get; set; }
        public string Title { get; set; } = string.Empty;
        public string? Description { get; set; }
        public ContentMimeType ContentMimeType { get; set; }
        public int OrderIndex { get; set; }
        public int? DurationMinutes { get; set; }
        public string? ExternalUrl { get; set; }
        public int? QuizId { get; set; }
        public bool IsFreePreview { get; set; }
        public bool IsDownloadable { get; set; }
        public bool IsMandatory { get; set; }
        public bool IsPublished { get; set; } = true;
    }

    #endregion

    #region Modules Management
    private Task HandleMoveDown(CourseModuleDto module)
    {
        var index = _modules.IndexOf(module);
        var count = _modules.Count;
        if (count <= 1 || index < 0)
            return Task.CompletedTask;

        if (index < count - 1)
        {
            // Swap with the next module
            var next = _modules[index + 1];
            _modules[index + 1] = module;
            _modules[index] = next;

            // Update order indices
            module.OrderIndex = index + 1;
            next.OrderIndex = index;
        }
        else
        {
            // Last item: swap with the first module
            var first = _modules[0];
            _modules[0] = module;
            _modules[count - 1] = first;

            // Update order indices
            module.OrderIndex = 0;
            first.OrderIndex = count - 1;
        }
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task HandleMoveUp(CourseModuleDto module)
    {
        var index = _modules.IndexOf(module);
        var count = _modules.Count;
        if (count <= 1 || index < 0)
            return Task.CompletedTask;

        if (index > 0)
        {
            // Swap with the previous module
            var prev = _modules[index - 1];
            _modules[index - 1] = module;
            _modules[index] = prev;

            // Update order indices
            module.OrderIndex = index - 1;
            prev.OrderIndex = index;
        }
        else
        {
            // First item: swap with the last module
            var last = _modules[count - 1];
            _modules[count - 1] = module;
            _modules[0] = last;

            // Update order indices
            module.OrderIndex = count - 1;
            last.OrderIndex = 0;
        }

        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task HandleAddNewContent(CourseModuleDto module)
    {
        try
        {
            //_expandedModules[module.Id] = true;
            //StateHasChanged();
        
            var dialogData = new CourseContentDto()
            {
                CourseModuleId = module.CourseId,
                OrderIndex = module.Contents.Count
            };

            var dialog = await DialogServiceProvider.ShowDialogAsync<ModuleAddContentDialog>(dialogData, new DialogParameters
            {
                Title = "Manage Course Modules",
                PrimaryAction = "Add Module",
                SecondaryAction = "Cancel",
                Width = "820px",
                Height = "auto",
                Modal = true,
                PreventDismissOnOverlayClick = true
            });

            var result = await dialog.Result;
            if (result is { Cancelled: false, Data: CourseContentDto data })
            {
                await SaveCourseModuleContent(module, data);
            }
        }
        catch (Exception e)
        {
           await ToastService.AddDismissibleMessage(nameof(SaveEntityResult.Error),$"An error occurred while adding content: {e.Message}", SaveEntityResult.Error);
        }
        //StateHasChanged();
    }

    private async Task SaveCourseModuleContent(CourseModuleDto module, CourseContentDto data)
    {
        //TODO: Implement saving different types of content based on CourseDialogData
        //throw new NotImplementedException();
    }

    #endregion
}
