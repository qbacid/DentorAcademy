@page "/user-management"
@using Dentor.Academy.Web.DTOs
@using Dentor.Academy.Web.Services
@using System.ComponentModel.DataAnnotations
@rendermode InteractiveServer
@inject UserManagementService UserManagementService
@inject IJSRuntime JS

@attribute [Authorize(Roles = "Admin")]

<PageTitle>User Management</PageTitle>

<div class="user-management-container">
    <div class="header-section">
        <h2>User Management</h2>
        
        <button type="button" class="btn btn-primary" @onclick="OpenCreateUserModal">
            <i class="bi bi-person-plus"></i> Create New User
        </button>
    </div>

    @if (!string.IsNullOrEmpty(_message))
    {
        <div class="alert @(_isError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
            @_message
            <button type="button" class="btn-close" @onclick="() => _message = string.Empty"></button>
        </div>
    }

    @if (_generatedPassword != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Generated Password:</strong> @_generatedPassword
            <br/>
            <small>Please save this password. It will not be shown again.</small>
            <button type="button" class="btn-close" @onclick="() => _generatedPassword = null"></button>
        </div>
    }

    @if (_loading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Roles</th>
                        <th>Must Change Password</th>
                        <th>Created</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in _users)
                    {
                        <tr>
                            <td>@user.UserName</td>
                            <td>
                                @user.Email
                                @if (user.EmailConfirmed)
                                {
                                    <i class="bi bi-check-circle-fill text-success" title="Email confirmed"></i>
                                }
                            </td>
                            <td>
                                @foreach (var role in user.Roles)
                                {
                                    <span class="badge bg-secondary me-1">@role</span>
                                }
                            </td>
                            <td>
                                @if (user.MustChangePassword)
                                {
                                    <span class="badge bg-warning">Yes</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">No</span>
                                }
                            </td>
                            <td>@user.CreatedAt?.ToString("MMM dd, yyyy")</td>
                            <td>@(user.LastLogin?.ToString("MMM dd, yyyy") ?? "Never")</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary" @onclick="() => OpenEditUserModal(user)" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" @onclick="() => ResetUserPassword(user.Id)" title="Reset Password">
                                        <i class="bi bi-key"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" @onclick="() => DeleteUser(user.Id)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (_showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="HandleBackdropClick">
        <div class="modal-dialog modal-lg" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(_editingUser == null ? "Create New User" : "Edit User")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="_userForm" OnValidSubmit="HandleUserSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <InputText @bind-Value="_userForm.Email" class="form-control" type="email" />
                            <ValidationMessage For="() => _userForm.Email" />
                            <small class="form-text text-muted">Email will be used as username</small>
                        </div>

                        @if (_editingUser == null)
                        {
                            <div class="mb-3">
                                <div class="form-check">
                                    <InputCheckbox @bind-Value="_userForm.GenerateRandomPassword" class="form-check-input" id="generatePassword" />
                                    <label class="form-check-label" for="generatePassword">
                                        Generate Random Password (User will be required to change it)
                                    </label>
                                </div>
                            </div>

                            @if (!_userForm.GenerateRandomPassword)
                            {
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <InputText @bind-Value="_userForm.Password" class="form-control" type="password" />
                                    <ValidationMessage For="() => _userForm.Password" />
                                    <small class="form-text text-muted">
                                        Password must be at least 6 characters and contain uppercase, lowercase, digit, and special character.
                                    </small>
                                </div>
                            }
                        }

                        <div class="mb-3">
                            <label class="form-label">Roles</label>
                            @foreach (var role in _availableRoles)
                            {
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" 
                                           id="role_@role" 
                                           checked="@_userForm.Roles.Contains(role)"
                                           @onchange="@((e) => ToggleRole(role, (bool)e.Value!))" />
                                    <label class="form-check-label" for="role_@role">@role</label>
                                </div>
                            }
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                            <button type="submit" class="btn btn-primary" disabled="@_processing">
                                @if (_processing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                @(_editingUser == null ? "Create User" : "Update User")
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<UserDto> _users = new();
    private List<string> _availableRoles = new();
    private bool _loading = true;
    private bool _showModal = false;
    private bool _processing = false;
    private string? _message;
    private bool _isError;
    private string? _generatedPassword;
    private UserDto? _editingUser;
    private UserFormModel _userForm = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        await LoadRoles();
    }

    private async Task LoadUsers()
    {
        _loading = true;
        try
        {
            _users = await UserManagementService.GetAllUsersAsync();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadRoles()
    {
        _availableRoles = await UserManagementService.GetAllRolesAsync();
    }

    private void OpenCreateUserModal()
    {
        _editingUser = null;
        _userForm = new UserFormModel 
        { 
            GenerateRandomPassword = true,
            Roles = new List<string>()
        };
        _showModal = true;
        _message = string.Empty;
        _generatedPassword = null;
    }

    private void OpenEditUserModal(UserDto user)
    {
        _editingUser = user;
        _userForm = new UserFormModel
        {
            Email = user.Email,
            Roles = user.Roles.ToList()
        };
        _showModal = true;
        _message = string.Empty;
        _generatedPassword = null;
    }

    private void CloseModal()
    {
        _showModal = false;
        _editingUser = null;
        _userForm = new();
        _processing = false;
    }

    private void HandleBackdropClick()
    {
        if (!_processing)
        {
            CloseModal();
        }
    }

    private void ToggleRole(string role, bool isChecked)
    {
        if (isChecked && !_userForm.Roles.Contains(role))
        {
            _userForm.Roles.Add(role);
        }
        else if (!isChecked && _userForm.Roles.Contains(role))
        {
            _userForm.Roles.Remove(role);
        }
    }

    private async Task HandleUserSubmit()
    {
        if (_processing) return;
        
        _processing = true;
        StateHasChanged();

        try
        {
            UserManagementResult result;

            if (_editingUser == null)
            {
                // Create new user - use email as username
                var createDto = new CreateUserDto
                {
                    UserName = _userForm.Email,  // Use email as username
                    Email = _userForm.Email,
                    GenerateRandomPassword = _userForm.GenerateRandomPassword,
                    Password = _userForm.Password,
                    Roles = _userForm.Roles
                };

                result = await UserManagementService.CreateUserAsync(createDto);
            }
            else
            {
                // Update existing user - use email as username
                var updateDto = new UpdateUserDto
                {
                    Id = _editingUser.Id,
                    UserName = _userForm.Email,  // Use email as username
                    Email = _userForm.Email,
                    Roles = _userForm.Roles
                };

                result = await UserManagementService.UpdateUserAsync(updateDto);
            }

            if (result.Success)
            {
                _message = result.Message;
                _isError = false;
                _generatedPassword = result.GeneratedPassword;
                CloseModal();
                await LoadUsers();
            }
            else
            {
                _message = result.Message + " " + string.Join(", ", result.Errors);
                _isError = true;
            }
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task ResetUserPassword(string userId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to reset this user's password? A new random password will be generated.");
        if (!confirmed) return;

        _processing = true;
        try
        {
            var result = await UserManagementService.ResetPasswordAsync(userId);
            
            if (result.Success)
            {
                _message = result.Message;
                _isError = false;
                _generatedPassword = result.GeneratedPassword;
                await LoadUsers();
            }
            else
            {
                _message = result.Message + " " + string.Join(", ", result.Errors);
                _isError = true;
            }
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task DeleteUser(string userId)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this user? This action cannot be undone.");
        if (!confirmed) return;

        _processing = true;
        try
        {
            var result = await UserManagementService.DeleteUserAsync(userId);
            
            if (result.Success)
            {
                _message = result.Message;
                _isError = false;
                await LoadUsers();
            }
            else
            {
                _message = result.Message + " " + string.Join(", ", result.Errors);
                _isError = true;
            }
        }
        finally
        {
            _processing = false;
        }
    }

    private class UserFormModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = string.Empty;

        public bool GenerateRandomPassword { get; set; } = true;

        [StringLength(100, MinimumLength = 6, ErrorMessage = "Password must be at least 6 characters")]
        public string? Password { get; set; }

        public List<string> Roles { get; set; } = new();
    }
}
