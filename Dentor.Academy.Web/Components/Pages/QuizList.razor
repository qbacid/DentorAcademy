@page "/quizzes"
@using Dentor.Academy.Web.Data
@using Dentor.Academy.Web.Models
@using Microsoft.EntityFrameworkCore
@inject QuizDbContext DbContext
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Available Quizzes</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="m-0">Available Quizzes</h2>
        <a href="/quiz-import" class="btn btn-primary">
            Import New Quiz
        </a>
    </div>

    @if (quizzes == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading quizzes...</p>
        </div>
    }
    else if (!quizzes.Any())
    {
        <div class="card border-0 shadow-sm text-center p-5 bg-light">
            <h4 class="mb-3">No Quizzes Available</h4>
            <p class="text-muted mb-4">Import a quiz to get started.</p>
            <a href="/quiz-import" class="btn btn-primary">Import Quiz</a>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var quiz in quizzes)
            {
                <div class="col-sm-6 col-lg-4">
                    <div class="quiz-list-card" role="button" tabindex="0"
                         @onclick="() => StartQuiz(quiz.Id)"
                         @onkeydown="(e) => CardKeyDown(e, quiz.Id)">
                        <div class="qlc-header" title="@quiz.Title">@quiz.Title</div>
                        <div class="qlc-body">
                            @if (!string.IsNullOrWhiteSpace(quiz.Description))
                            {
                                <p class="qlc-desc">@quiz.Description</p>
                            }
                            else
                            {
                                <p class="qlc-desc qlc-desc-empty fst-italic text-muted">No description provided.</p>
                            }
                            <div class="qlc-meta text-muted">
                                <span>@quiz.QuestionCount question@(quiz.QuestionCount == 1 ? "" : "s")</span>
                                @if (quiz.TimeLimitMinutes.HasValue)
                                {
                                    <span>&bull; @quiz.TimeLimitMinutes min</span>
                                }
                                <span>&bull; Pass @quiz.PassingScore%</span>
                            </div>
                        </div>
                        <div class="qlc-footer">
                            <span class="qlc-action text-primary">Start &rsaquo;</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<QuizListItem>? quizzes;

    protected override async Task OnInitializedAsync()
    {
        await LoadQuizzes();
    }

    private async Task LoadQuizzes()
    {
        quizzes = await DbContext.Quizzes
            .Where(q => q.IsActive)
            .Select(q => new QuizListItem
            {
                Id = q.Id,
                Title = q.Title,
                Description = q.Description,
                PassingScore = q.PassingScore,
                TimeLimitMinutes = q.TimeLimitMinutes,
                QuestionCount = q.Questions.Count
            })
            .OrderByDescending(q => q.Id)
            .ToListAsync();
    }

    private void StartQuiz(int quizId)
    {
        Navigation.NavigateTo($"/quiz/{quizId}");
    }

    private void CardKeyDown(KeyboardEventArgs e, int quizId)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            StartQuiz(quizId);
        }
    }

    private class QuizListItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string? Description { get; set; }
        public decimal PassingScore { get; set; }
        public int? TimeLimitMinutes { get; set; }
        public int QuestionCount { get; set; }
    }
}
