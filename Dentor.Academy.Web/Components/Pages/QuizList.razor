@page "/quizzes"
@using Dentor.Academy.Web.Data
@using Dentor.Academy.Web.DTOs
@using Dentor.Academy.Web.DTOs.Quiz
@using Microsoft.EntityFrameworkCore
@inject QuizDbContext DbContext
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Available Quizzes</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="m-0">Available Quizzes</h2>
        <AuthorizeView Roles="Admin">
            <Authorized>
                <a href="/quiz-import" class="btn btn-secondary" style="border-radius: 8px">
                    Import New Quiz
                </a>
            </Authorized>
        </AuthorizeView>
    </div>

    @if (quizzes == null)
    {
        <LoadingSpinner Message="Loading quizzes..." />
    }
    else if (!quizzes.Any())
    {
        <EmptyState 
            Title="No Quizzes Available"
            Message="Import a quiz to get started."
            IconClass="bi bi-inbox"
            ShowAction="true"
            ActionText="Import Quiz"
            ActionUrl="/quiz-import"
            RequiredRole="Admin" />
    }
    else
    {
        <QuizCardGrid Quizzes="@quizzes" OnQuizSelected="@StartQuiz" />
    }
</div>

@code {
    private List<QuizCardDto>? quizzes;

    protected override async Task OnInitializedAsync()
    {
        await LoadQuizzes();
    }

    private async Task LoadQuizzes()
    {
        quizzes = await DbContext.Quizzes
            .Where(q => q.IsActive)
            .Select(q => new QuizCardDto
            {
                Id = q.Id,
                Title = q.Title,
                Description = q.Description,
                Category = q.Category,
                PassingScore = q.PassingScore,
                TimeLimitMinutes = q.TimeLimitMinutes,
                QuestionCount = q.Questions.Count
            })
            .OrderByDescending(q => q.Id)
            .ToListAsync();
    }

    private void StartQuiz(int quizId)
    {
        Navigation.NavigateTo($"/quiz/{quizId}");
    }
}
