@page "/courses"

@using Dentor.Academy.Web.DTOs.Course
@using Dentor.Academy.Web.Interfaces
@using Microsoft.AspNetCore.Identity

@inject ICourseManagementService CourseService
@inject ICourseCategoryService CategoryService
@inject NavigationManager Navigation
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

@rendermode InteractiveServer

<PageTitle>Available Courses</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="m-0">Available Courses</h2>
        <AuthorizeView Roles="Admin,Instructor">
            <Authorized>
                <a href="/admin/courses" class="btn btn-secondary" style="border-radius: 8px">
                    <i class="bi bi-gear"></i> Manage Courses
                </a>
            </Authorized>
        </AuthorizeView>
    </div>

    <!-- Category Filter -->
    @if (_categories.Any())
    {
        <div class="mb-4">
            <div class="btn-group flex-wrap" role="group">
                <button type="button" 
                        class="btn @(_selectedCategoryId == null ? "btn-primary" : "btn-outline-primary")"
                        @onclick="() => FilterByCategory(null)"
                        style="border-radius: 8px 0 0 8px">
                    All Courses (@_allCoursesCount)
                </button>
                @foreach (var category in _categories)
                {
                    <button type="button" 
                            class="btn @(_selectedCategoryId == category.Id ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => FilterByCategory(category.Id)">
                        @category.Name (@category.CourseCount)
                    </button>
                }
            </div>
        </div>
    }

    @if (_loading)
    {
        <LoadingSpinner Message="Loading courses..." />
    }
    else if (!_filteredCourses.Any())
    {
        <EmptyState 
            Title="No Courses Available"
            Message="@(_selectedCategoryId.HasValue ? "No courses found in this category." : "Check back later for new courses.")"
            IconClass="bi bi-journal-x"
            ShowAction="true"
            ActionText="View All Courses"
            ActionUrl="/courses"
            RequiredRole="" />
    }
    else
    {
        <CourseCardGrid 
            Courses="@_filteredCourses" 
            EnrolledCourseIds="@_enrolledCourseIds"
            EnrollingCourseId="@_enrollingCourseId"
            OnCourseEnroll="@EnrollInCourse"
            OnCourseView="@ViewCourse" />
    }
</div>

@if (!string.IsNullOrEmpty(_message))
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div class="toast show" role="alert">
            <div class="toast-header @(_messageType == "success" ? "bg-success text-white" : "bg-danger text-white")">
                <strong class="me-auto">
                    @if (_messageType == "success")
                    {
                        <i class="bi bi-check-circle"></i>
                        <span>Success</span>
                    }
                    else
                    {
                        <i class="bi bi-exclamation-circle"></i>
                        <span>Error</span>
                    }
                </strong>
                <button type="button" class="btn-close" @onclick="() => _message = string.Empty"></button>
            </div>
            <div class="toast-body">
                @_message
            </div>
        </div>
    </div>
}

@code {
    private List<CourseListDto> _courses = new();
    private List<CourseListDto> _filteredCourses = new();
    private List<CourseCategoryDto> _categories = new();
    private HashSet<int> _enrolledCourseIds = new();
    
    private bool _loading = true;
    private int? _enrollingCourseId = null;
    private int? _selectedCategoryId = null;
    private int _allCoursesCount = 0;
    private string _message = string.Empty;
    private string _messageType = "success";
    private string? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            // Get current user
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _currentUserId = UserManager.GetUserId(authState.User);

            // Load data sequentially to avoid DbContext threading issues
            await LoadCategories();
            await LoadCourses();

            // Check enrollment status
            if (!string.IsNullOrEmpty(_currentUserId))
            {
                await CheckEnrollmentStatus();
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadCourses()
    {
        _courses = await CourseService.GetAllCoursesAsync(null, true); // Only published courses
        _allCoursesCount = _courses.Count;
        _filteredCourses = _courses;
    }

    private async Task LoadCategories()
    {
        var allCategories = await CategoryService.GetAllCategoriesAsync(includeInactive: false);
        // Only show categories that have published courses
        _categories = allCategories.Where(c => c.CourseCount > 0).ToList();
    }

    private async Task CheckEnrollmentStatus()
    {
        if (string.IsNullOrEmpty(_currentUserId)) return;

        var enrolledCourseIds = await CourseService.GetUserEnrolledCourseIdsAsync(_currentUserId);
        _enrolledCourseIds = enrolledCourseIds.ToHashSet();
    }

    private void FilterByCategory(int? categoryId)
    {
        _selectedCategoryId = categoryId;
        
        if (categoryId == null)
        {
            _filteredCourses = _courses;
        }
        else
        {
            _filteredCourses = _courses.Where(c => c.CategoryId == categoryId).ToList();
        }
    }

    private async Task EnrollInCourse(int courseId)
    {
        if (string.IsNullOrEmpty(_currentUserId))
        {
            ShowMessage("Please log in to enroll in courses", "error");
            Navigation.NavigateTo("/login");
            return;
        }

        _enrollingCourseId = courseId;
        try
        {
            var result = await CourseService.EnrollUserAsync(courseId, _currentUserId);
            if (result.Success)
            {
                ShowMessage("Successfully enrolled in course!", "success");
                _enrolledCourseIds.Add(courseId);
            }
            else
            {
                ShowMessage(string.Join(", ", result.Errors), "error");
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"Error enrolling in course: {ex.Message}", "error");
        }
        finally
        {
            _enrollingCourseId = null;
        }
    }

    private void ViewCourse(int courseId)
    {
        Navigation.NavigateTo($"/course/{courseId}");
    }

    private void ShowMessage(string message, string type)
    {
        _message = message;
        _messageType = type;
        StateHasChanged();
        
        // Auto-hide after 5 seconds
        Task.Delay(5000).ContinueWith(_ => 
        {
            _message = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }
}
