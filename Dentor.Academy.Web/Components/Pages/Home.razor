@page "/"
@using Dentor.Academy.Web.Data
@using Dentor.Academy.Web.DTOs
@using Microsoft.EntityFrameworkCore
@inject QuizDbContext DbContext
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Luxadent Pro Academy - Home</PageTitle>

<div class="py-3 mb-2">
    <div class="container">
        <div class="row justify-content-center text-center">
            <div class="col-lg-8">
                <h4 class="display-4 fw-bold mb-3">Welcome to Luxadent Pro Training Center</h4>
                <p class="lead text-muted mb-2">
                    Test your knowledge and enhance your learning with our interactive quizzes. 
                    Choose a quiz below to get started!
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    @if (quizzes == null)
    {
        <LoadingSpinner Message="Loading quizzes..." />
    }
    else if (!quizzes.Any())
    {
        <EmptyState 
            Title="No Quizzes Available Yet"
            Message="There are no quizzes available at the moment. Import your first quiz to get started!"
            IconClass="bi bi-inbox"
            ShowAction="true"
            ActionText="Import Quiz"
            ActionIconClass="bi bi-upload"
            ActionUrl="/quiz-import"
            RequiredRole="Admin" />
    }
    else
    {
        <!-- Stats Section -->
        <div class="mb-2">
            <h3 class="mb-3">Available Quizzes/Exercises</h3>
            <p class="text-muted">Click on any quiz card to begin</p>
        </div>
        
        <!-- Stats Card -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="stat-item">
                                    <h3 class="text-primary mb-1">@quizzes.Count</h3>
                                    <p class="text-muted mb-0">Available Quizzes</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-item">
                                    <h3 class="text-primary mb-1">@totalQuestions</h3>
                                    <p class="text-muted mb-0">Total Questions</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-item">
                                    <h3 class="text-primary mb-1">@categoriesCount</h3>
                                    <p class="text-muted mb-0">Categories</p>
                                </div>
                            </div>
                            <AuthorizeView>
                                <Authorized>
                                    <div class="col-md-3">
                                        <div class="stat-item">
                                            <h3 class="text-primary mb-1">
                                                @if (communityAverageScore.HasValue)
                                                {
                                                    @($"{communityAverageScore.Value:F0}%")
                                                }
                                                else
                                                {
                                                    <span>--</span>
                                                }
                                            </h3>
                                            <p class="text-muted mb-0">Community Score</p>
                                        </div>
                                    </div>
                                </Authorized>
                            </AuthorizeView>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Cards Grid -->
        <QuizCardGrid Quizzes="@quizzes" OnQuizSelected="@NavigateToQuiz" />
    }
</div>

@code {
    private List<QuizCardDto>? quizzes;
    private int totalQuestions => quizzes?.Sum(q => q.QuestionCount) ?? 0;
    private int categoriesCount => quizzes?
        .Where(q => !string.IsNullOrWhiteSpace(q.Category))
        .Select(q => q.Category)
        .Distinct()
        .Count() ?? 0;
    private decimal? communityAverageScore;

    protected override async Task OnInitializedAsync()
    {
        await LoadQuizzes();
        await LoadCommunityAverageScore();
    }

    private async Task LoadQuizzes()
    {
        quizzes = await DbContext.Quizzes
            .Where(q => q.IsActive)
            .Select(q => new QuizCardDto
            {
                Id = q.Id,
                Title = q.Title,
                Description = q.Description,
                Category = q.Category,
                PassingScore = q.PassingScore,
                TimeLimitMinutes = q.TimeLimitMinutes,
                QuestionCount = q.Questions.Count
            })
            .OrderByDescending(q => q.Id)
            .ToListAsync();
    }

    private async Task LoadCommunityAverageScore()
    {
        var completedAttempts = await DbContext.QuizAttempts
            .Where(qa => qa.CompletedAt.HasValue && qa.Score.HasValue)
            .Select(qa => qa.Score!.Value)
            .ToListAsync();
        
        if (completedAttempts.Any())
        {
            communityAverageScore = completedAttempts.Average();
        }
        else
        {
            communityAverageScore = null;
        }
    }

    private void NavigateToQuiz(int quizId)
    {
        Navigation.NavigateTo($"/quiz/{quizId}");
    }
}
