@page "/"
@using Dentor.Academy.Web.Data
@using Dentor.Academy.Web.Models
@using Microsoft.EntityFrameworkCore
@inject QuizDbContext DbContext
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Luxadent Pro Academy - Home</PageTitle>

<div class="py-5 mb-2">
    <div class="container">
        <div class="row justify-content-center text-center">
            <div class="col-lg-8">
                <h2 class="display-4 fw-bold mb-3">Welcome to Luxadent Pro Training Center</h2>
                <p class="lead text-muted mb-2">
                    Test your knowledge and enhance your learning with our interactive quizzes. 
                    Choose a quiz below to get started!
                </p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    @if (quizzes == null)
    {
        <!-- Loading State -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading quizzes...</p>
        </div>
    }
    else if (!quizzes.Any())
    {
        <!-- Empty State -->
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <h3 class="mb-3">No Quizzes Available Yet</h3>
                        <p class="text-muted mb-4">
                            There are no quizzes available at the moment. 
                            Import your first quiz to get started!
                        </p>
                        <a href="/quiz-import" class="btn btn-primary btn-lg">
                            <i class="bi bi-upload"></i> Import Quiz
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Stats Section -->
        <div class="mb-2">
            <h3 class="mb-3">Available Quizzes/Exercises</h3>
            <p class="text-muted">Click on any quiz card to begin</p>
        </div>
        
        <!-- Quizzes Grid -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="stat-item">
                                    <h3 class="text-primary mb-1">@quizzes.Count</h3>
                                    <p class="text-muted mb-0">Available Quizzes</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-item">
                                    <h3 class="text-primary mb-1">@totalQuestions</h3>
                                    <p class="text-muted mb-0">Total Questions</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-item">
                                    <h3 class="text-primary mb-1">@categoriesCount</h3>
                                    <p class="text-muted mb-0">Categories</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-2">
            @foreach (var quiz in quizzes)
            {
                <div class="col">
                    <div class="card h-100 quiz-card" @onclick="@(() => NavigateToQuiz(quiz.Id))">
                        <div class="card-header text-white">
                            <h5 class="card-title mb-0 text-truncate" title="@quiz.Title">
                                @quiz.Title
                            </h5>
                        </div>
                        <div class="card-body d-flex flex-column">
                            @if (!string.IsNullOrEmpty(quiz.Description))
                            {
                                <p class="card-text text-muted flex-grow-1 quiz-description">
                                    @quiz.Description
                                </p>
                            }
                            else
                            {
                                <p class="card-text text-muted flex-grow-1 fst-italic">
                                    No description available
                                </p>
                            }
                            
                            <div class="quiz-info mt-3">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-list-check text-primary me-2"></i>
                                    <small class="text-muted">
                                        <strong>@quiz.QuestionCount</strong> Questions
                                    </small>
                                </div>
                                
                                @if (quiz.TimeLimitMinutes.HasValue)
                                {
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-clock text-primary me-2"></i>
                                        <small class="text-muted">
                                            <strong>@quiz.TimeLimitMinutes</strong> Minutes
                                        </small>
                                    </div>
                                }
                                
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-trophy text-primary me-2"></i>
                                    <small class="text-muted">
                                        Pass at <strong>@quiz.PassingScore%</strong>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-grid">
                                <button class="btn btn-primary btn-sm">
                                    <i class="bi bi-play-circle-fill"></i> Start Quiz
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

       
    }
</div>

@code {
    private List<QuizCardItem>? quizzes;
    private int totalQuestions => quizzes?.Sum(q => q.QuestionCount) ?? 0;
    private int categoriesCount => quizzes?.Select(q => q.Title.Split(' ').FirstOrDefault()).Distinct().Count() ?? 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadQuizzes();
    }

    private async Task LoadQuizzes()
    {
        quizzes = await DbContext.Quizzes
            .Where(q => q.IsActive)
            .Select(q => new QuizCardItem
            {
                Id = q.Id,
                Title = q.Title,
                Description = q.Description,
                PassingScore = q.PassingScore,
                TimeLimitMinutes = q.TimeLimitMinutes,
                QuestionCount = q.Questions.Count
            })
            .OrderByDescending(q => q.Id)
            .ToListAsync();
    }

    private void NavigateToQuiz(int quizId)
    {
        Navigation.NavigateTo($"/quiz/{quizId}");
    }

    private class QuizCardItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string? Description { get; set; }
        public decimal PassingScore { get; set; }
        public int? TimeLimitMinutes { get; set; }
        public int QuestionCount { get; set; }
    }
}
