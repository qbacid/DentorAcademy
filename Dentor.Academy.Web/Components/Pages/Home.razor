@page "/"

@using Dentor.Academy.Web.DTOs.Course
@using Dentor.Academy.Web.Interfaces
@using Microsoft.AspNetCore.Identity

@inject ICourseManagementService CourseService
@inject ICourseCategoryService CategoryService
@inject IQuizTakingService QuizService
@inject NavigationManager Navigation
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider

@rendermode InteractiveServer

<PageTitle>Luxadent Pro Academy - Home</PageTitle>

<!-- LinkedIn-Style Hero Section -->
<div class="linkedin-hero">
    <div class="linkedin-container">
        <div class="linkedin-hero-content">
            <h1 class="linkedin-hero-title">Welcome to Luxadent Pro Training Center</h1>
            <p class="linkedin-hero-subtitle">
                Advance your dental expertise with professional courses and certifications. 
                Learn from industry experts and enhance your practice with cutting-edge techniques.
            </p>
        </div>
    </div>
</div>

<div class="linkedin-container">
    <!-- Category Navigation - LinkedIn Style -->
    <div class="linkedin-nav-tabs">
        <button type="button" 
                class="linkedin-nav-tab @(_selectedCategoryId == null ? "active" : "")"
                @onclick="() => FilterByCategory(null)">
            All Courses
            <span class="badge">@_allCoursesCount</span>
        </button>
        @foreach (var category in _categories)
        {
            <button type="button" 
                    class="linkedin-nav-tab @(_selectedCategoryId == category.Id ? "active" : "")"
                    @onclick="() => FilterByCategory(category.Id)">
                @category.Name
                <span class="badge">@category.CourseCount</span>
            </button>
        }
    </div>

    <!-- Section Header -->
    <div class="linkedin-section-header">
        <h2 class="linkedin-section-title">
            @if (_selectedCategoryId == null)
            {
                <span>All Courses</span>
            }
            else
            {
                var selectedCategory = _categories.FirstOrDefault(c => c.Id == _selectedCategoryId);
                <span>@(selectedCategory?.Name ?? "Courses")</span>
            }
        </h2>
        <AuthorizeView Roles="Admin,Instructor">
            <Authorized>
                <a href="/admin/courses" class="linkedin-section-action">
                    <i class="bi bi-gear"></i>
                    <span>Manage Courses</span>
                </a>
            </Authorized>
        </AuthorizeView>
    </div>

    @if (_loading)
    {
        <!-- LinkedIn-Style Loading Skeleton -->
        <div class="linkedin-grid">
            @for (int i = 0; i < 8; i++)
            {
                <div class="linkedin-skeleton linkedin-skeleton-card"></div>
            }
        </div>
    }
    else if (_filteredCourses.Count == 0)
    {
        <div class="linkedin-empty-state">
            <div class="linkedin-empty-state-icon">
                <i class="bi bi-mortarboard"></i>
            </div>
            <h3 class="linkedin-empty-state-title">No courses available</h3>
            <p class="linkedin-empty-state-description">
                There are currently no courses in this category. Check back soon for new content!
            </p>
        </div>
    }
    else
    {
        <!-- Course Cards Grid - LinkedIn Style -->
        <div class="linkedin-grid">
            @foreach (var course in _filteredCourses)
            {
                <div class="linkedin-card linkedin-fade-in-up">
                    <div class="linkedin-card-image-wrapper" @onclick="() => ViewCourse(course.Id)">
                        @if (!string.IsNullOrEmpty(course.ThumbnailUrl))
                        {
                            <img src="@course.ThumbnailUrl" alt="@course.Title" class="linkedin-card-image" />
                        }
                        else
                        {
                            <div class="linkedin-card-image" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                        }
                        @if (_enrolledCourseIds.Contains(course.Id))
                        {
                            <span class="linkedin-card-badge">Enrolled</span>
                        }
                    </div>
                    
                    <div class="linkedin-card-body">
                        <div class="linkedin-card-category">@course.Category</div>
                        <h3 class="linkedin-card-title" @onclick="() => ViewCourse(course.Id)">@course.Title</h3>
                        <p class="linkedin-card-description">@course.ShortDescription</p>
                        
                        <div class="linkedin-card-meta">
                            @if (course.EstimatedDurationHours > 0)
                            {
                                <div class="linkedin-card-meta-item">
                                    <i class="bi bi-clock"></i>
                                    <span>@course.EstimatedDurationHours hrs</span>
                                </div>
                            }
                            @if (course.ModuleCount > 0)
                            {
                                <div class="linkedin-card-meta-item">
                                    <i class="bi bi-collection-play"></i>
                                    <span>@course.ModuleCount modules</span>
                                </div>
                            }
                        </div>
                        
                        <div class="linkedin-card-footer">
                            <div class="linkedin-card-instructor">
                                <span class="linkedin-card-instructor-name">@course.CreatedByUserName</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Quizzes Section -->
    <div class="linkedin-divider"></div>
    
    <div class="linkedin-section-header">
        <h2 class="linkedin-section-title">Quick Practice Quizzes</h2>
        <a href="/quizzes" class="linkedin-section-action">
            <span>View All</span>
            <i class="bi bi-arrow-right"></i>
        </a>
    </div>
    
    <p class="linkedin-text-secondary mb-4">Test your knowledge with our interactive quizzes</p>
    
    @if (_quizzes == null)
    {
        <div class="linkedin-grid">
            @for (int i = 0; i < 4; i++)
            {
                <div class="linkedin-skeleton linkedin-skeleton-card"></div>
            }
        </div>
    }
    else if (!_quizzes.Any())
    {
        <div class="linkedin-empty-state">
            <div class="linkedin-empty-state-icon">
                <i class="bi bi-question-circle"></i>
            </div>
            <h3 class="linkedin-empty-state-title">No quizzes available</h3>
            <p class="linkedin-empty-state-description">
                Check back soon for new quizzes to test your knowledge!
            </p>
        </div>
    }
    else
    {
        <div class="linkedin-grid">
            @foreach (var quiz in _quizzes.Take(4))
            {
                <div class="linkedin-card linkedin-fade-in-up">
                    <div class="linkedin-card-body">
                        <div class="linkedin-card-category">Quiz</div>
                        <h3 class="linkedin-card-title">@quiz.Title</h3>
                        <p class="linkedin-card-description">@quiz.Description</p>
                        
                        <div class="linkedin-card-meta">
                            <div class="linkedin-card-meta-item">
                                <i class="bi bi-question-circle"></i>
                                <span>@quiz.QuestionCount questions</span>
                            </div>
                            @if (quiz.TimeLimitMinutes.HasValue)
                            {
                                <div class="linkedin-card-meta-item">
                                    <i class="bi bi-clock"></i>
                                    <span>@quiz.TimeLimitMinutes min</span>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <div style="padding: 0 16px 16px;">
                        <button class="linkedin-btn linkedin-btn-primary linkedin-btn-block"
                                @onclick="() => NavigateToQuiz(quiz.Id)">
                            <i class="bi bi-play-circle"></i>
                            Start Quiz
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (!string.IsNullOrEmpty(_message))
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div class="toast show" role="alert">
            <div class="toast-header @(_messageType == "success" ? "bg-success text-white" : "bg-danger text-white")">
                <strong class="me-auto">
                    @if (_messageType == "success")
                    {
                        <i class="bi bi-check-circle"></i>
                        <span>Success</span>
                    }
                    else
                    {
                        <i class="bi bi-exclamation-circle"></i>
                        <span>Error</span>
                    }
                </strong>
                <button type="button" class="btn-close" @onclick="() => _message = string.Empty"></button>
            </div>
            <div class="toast-body">
                @_message
            </div>
        </div>
    </div>
}

@code {
    private List<QuizCardDto>? _quizzes;
    private List<CourseListDto> _courses = new();
    private List<CourseListDto> _filteredCourses = new();
    private List<CourseCategoryDto> _categories = new();
    private HashSet<int> _enrolledCourseIds = new();
    
    private bool _loading = true;
    private int? _selectedCategoryId;
    private int _allCoursesCount;
    private string _message = string.Empty;
    private string _messageType = "success";
    private string? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        try
        {
            // Get current user
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _currentUserId = UserManager.GetUserId(authState.User);

            // Load data sequentially to avoid DbContext threading issues
            await LoadCategories();
            await LoadCourses();
            await LoadQuizzes();

            // Check enrollment status
            if (!string.IsNullOrEmpty(_currentUserId))
            {
                await CheckEnrollmentStatus();
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadCourses()
    {
        _courses = await CourseService.GetAllCoursesAsync(null, true); // Only published courses
        _allCoursesCount = _courses.Count;
        _filteredCourses = _courses;
    }

    private async Task LoadCategories()
    {
        var allCategories = await CategoryService.GetAllCategoriesAsync(includeInactive: false);
        // Only show categories that have published courses
        _categories = allCategories.Where(c => c.CourseCount > 0).ToList();
    }

    private async Task LoadQuizzes()
    {
        _quizzes = await QuizService.GetAvailableQuizzesAsync();
    }

    private async Task CheckEnrollmentStatus()
    {
        if (string.IsNullOrEmpty(_currentUserId)) return;

        var enrolledCourseIds = await CourseService.GetUserEnrolledCourseIdsAsync(_currentUserId);
        _enrolledCourseIds = enrolledCourseIds.ToHashSet();
    }

    private void FilterByCategory(int? categoryId)
    {
        _selectedCategoryId = categoryId;
        
        if (categoryId == null)
        {
            _filteredCourses = _courses;
        }
        else
        {
            _filteredCourses = _courses.Where(c => c.CategoryId == categoryId).ToList();
        }
    }

    private void ViewCourse(int courseId)
    {
        Navigation.NavigateTo($"/courses/{courseId}");
    }

    private void NavigateToQuiz(int quizId)
    {
        Navigation.NavigateTo($"/quiz/{quizId}");
    }

    private void ShowMessage(string message, string type)
    {
        _message = message;
        _messageType = type;
        StateHasChanged();
        
        // Auto-hide after 5 seconds
        Task.Delay(5000).ContinueWith(_ => 
        {
            _message = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }
}
